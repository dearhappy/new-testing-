<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Information Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .step { display: none; }
        .step.active { display: block; }
        input, select { border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem; }
        .child-box { background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px dashed #cbd5e1; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

    <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-2xl">
        <h2 class="text-2xl font-bold mb-6 text-blue-600 border-b pb-2">Employee Registration</h2>
        
        <form id="onboardingForm">
            <!-- Hidden Fields (Now Blank by Default) -->
            <input type="hidden" name="Date of Joining" value="">
            <input type="hidden" name="Designation" value="">
            <input type="hidden" name="Grade" value="">
            <input type="hidden" name="Project Code" value="">
            <input type="hidden" name="Gross Salary" value="">
            <input type="hidden" name="Current Address" value="">
            <input type="hidden" name="Work Location" value="">
            <input type="hidden" name="Client Name" value="">
            <input type="hidden" name="PF Location" value="">
            <input type="hidden" name="UAN remarks" value="">
            <input type="hidden" name="ESI Remark" value="">

            <!-- STEP 1: Personal Information -->
            <div id="step1" class="step active">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Part 1: Personal & Bank Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>Employee Name (Aadhar)</label><input type="text" name="Employee Name(AsperAadhar)"></div>
                    <div><label>Date of Birth</label><input type="date" name="Date of Birth"></div>
                    <div><label>Gender</label><select name="Gender"><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                    <div><label>Blood Group</label><input type="text" name="Blood Group"></div>
                    <div><label>Marital Status</label><select name="Marital Status"><option value="">Select</option><option value="Single">Single</option><option value="Married">Married</option></select></div>
                    <div><label>Permanent Address</label><input type="text" name="Permanent Address"></div>
                    <div><label>Contact No</label><input type="tel" name="Contact No"></div>
                    <div><label>Emergency Contact No</label><input type="tel" name="Emergency Contact No"></div>
                    <div><label>Bank Name</label><input type="text" name="Bank Name"></div>
                    <div><label>Account No</label><input type="text" name="Account No"></div>
                    <div><label>IFSC Code</label><input type="text" name="IFSC Code"></div>
                    <div><label>UAN Number</label><input type="text" name="UAN Number"></div>
                    <div><label>Aadhar No</label><input type="text" name="AdharNo"></div>
                    <div><label>PAN Number</label><input type="text" name="Pan Number"></div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="button" onclick="nextStep(2)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Next: Family Details</button>
                </div>
            </div>

            <!-- STEP 2: Family Information -->
            <div id="step2" class="step">
                <h3 class="text-lg font-semibold mb-4 text-gray-700">Part 2: Family & Experience</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>Father's Name</label><input type="text" name="Father name"></div>
                    <div><label>Mother's Name</label><input type="text" name="Mother Name"></div>
                    <div><label>Wife's Name</label><input type="text" name="Wife Name"></div>
                    <div><label>Date of Marriage</label><input type="date" name="Date of Marriage"></div>
                    <div><label>No. of Children</label><input type="number" name="No.Childrens" id="numChildren" min="0" max="3" oninput="updateChildrenFields()"></div>
                    <div class="hidden md:block"></div> <!-- Spacer -->
                    
                    <!-- Dynamic Children Container -->
                    <div id="childrenContainer" class="col-span-full space-y-4 mt-2"></div>

                    <div><label>Email ID</label><input type="email" name="Email id"></div>
                    <div><label>Education</label><input type="text" name="Education"></div>
                    <div><label>Experience (Years)</label><input type="number" name="Scaffolding Work Experience"></div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="nextStep(1)" class="bg-gray-400 text-white px-6 py-2 rounded-lg hover:bg-gray-500">Back</button>
                    <button type="submit" id="submitBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Submit & Download PDF</button>
                </div>
            </div>
        </form>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwn1oDVHfFgKqMJfkguVyGxuY7WO5z9yupblXVc4J2zfiMZF6AJITZOWAZDJ3To-j0gBQ/exec'; 
        const form = document.getElementById('onboardingForm');

        function nextStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        function updateChildrenFields() {
            const container = document.getElementById('childrenContainer');
            const count = parseInt(document.getElementById('numChildren').value) || 0;
            const maxChildren = 3; 
            
            container.innerHTML = '';
            
            for (let i = 1; i <= Math.min(count, maxChildren); i++) {
                const childDiv = document.createElement('div');
                childDiv.className = 'child-box grid grid-cols-1 md:grid-cols-3 gap-3';
                childDiv.innerHTML = `
                    <div class="col-span-full font-bold text-gray-600 text-xs uppercase tracking-wider">Child ${i} Details</div>
                    <div>
                        <label>Child ${i} Name</label>
                        <input type="text" name="Child ${i} Name">
                    </div>
                    <div>
                        <label>Son/Daughter</label>
                        <select name="Son/Daughter">
                            <option value="">Select</option>
                            <option value="Son">Son</option>
                            <option value="Daughter">Daughter</option>
                        </select>
                    </div>
                    <div>
                        <label>Child ${i} DOB</label>
                        <input type="date" name="Child ${i} DOB">
                    </div>
                `;
                container.appendChild(childDiv);
            }
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerText = "Processing...";

            fetch(scriptURL, { method: 'POST', body: new FormData(form)})
                .then(response => response.json())
                .then(data => {
                    if(data.result === 'success') {
                        generatePDF();
                        alert('Data saved successfully. Your PDF is downloading.');
                        form.reset();
                        document.getElementById('childrenContainer').innerHTML = '';
                        nextStep(1);
                    } else {
                        throw new Error('Server error');
                    }
                })
                .catch(error => {
                    alert('Error submitting form. Please check Script URL.');
                    console.error('Error!', error.message);
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerText = "Submit & Download PDF";
                });
        });

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = new FormData(form);
            const get = (key) => data.get(key) || "________________";

            // Header Section
            doc.setFont("helvetica", "bold");
            doc.setFontSize(22);
            doc.text("EMPLOYEE JOINING FORM", 105, 20, { align: "center" });
            
            doc.setLineWidth(0.5);
            doc.line(20, 25, 190, 25);

            // 1. Personal Details
            doc.setFontSize(14);
            doc.text("1. PERSONAL INFORMATION", 20, 35);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            let y = 45;
            const drawRow = (label1, val1, label2, val2) => {
                doc.setFont("helvetica", "bold");
                doc.text(label1 + ":", 20, y);
                doc.setFont("helvetica", "normal");
                doc.text(String(val1), 65, y);
                
                if (label2) {
                    doc.setFont("helvetica", "bold");
                    doc.text(label2 + ":", 110, y);
                    doc.setFont("helvetica", "normal");
                    doc.text(String(val2), 150, y);
                }
                y += 8;
            };

            drawRow("Full Name", get("Employee Name(AsperAadhar)"), "Date of Birth", get("Date of Birth"));
            drawRow("Gender", get("Gender"), "Blood Group", get("Blood Group"));
            drawRow("Marital Status", get("Marital Status"), "Contact No", get("Contact No"));
            drawRow("Email ID", get("Email id"), "Education", get("Education"));
            drawRow("Permanent Addr", get("Permanent Address"), "", "");

            y += 5;
            // 2. Statutory & Bank Details
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("2. STATUTORY & BANK DETAILS", 20, y);
            y += 10;
            doc.setFontSize(10);
            drawRow("Aadhar No", get("AdharNo"), "PAN Number", get("Pan Number"));
            drawRow("UAN Number", get("UAN Number"), "Bank Name", get("Bank Name"));
            drawRow("Account No", get("Account No"), "IFSC Code", get("IFSC Code"));
            
            y += 5;
            // 3. Family Details
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("3. FAMILY DETAILS", 20, y);
            y += 10;
            doc.setFontSize(10);
            drawRow("Father's Name", get("Father name"), "Mother's Name", get("Mother Name"));
            drawRow("Wife's Name", get("Wife Name"), "Marriage Date", get("Date of Marriage"));
            
            const numChildren = parseInt(data.get("No.Childrens")) || 0;
            if (numChildren > 0) {
                y += 2;
                doc.setFont("helvetica", "italic");
                doc.text("Children Details:", 20, y);
                y += 8;
                for (let i = 1; i <= Math.min(numChildren, 3); i++) {
                    drawRow(`Child ${i} Name`, get(`Child ${i} Name`), `DOB/Gender`, `${get(`Child ${i} DOB`)} / ${get(`Son/Daughter`)}`);
                }
            }

            y += 10;
            // 4. Experience & Emergency
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("4. EMERGENCY & EXPERIENCE", 20, y);
            y += 10;
            doc.setFontSize(10);
            drawRow("Emergency Contact", get("Emergency Contact No"), "Relation", get("Employee Relationwith EmergencyContactNo"));
            drawRow("Experience", get("Scaffolding Work Experience") + " Years", "", "");

            // Footer
            y = 260;
            doc.line(20, y, 70, y);
            doc.line(140, y, 190, y);
            y += 5;
            doc.setFontSize(9);
            doc.text("Employee Signature", 35, y, { align: "center" });
            doc.text("Authorized Signatory", 165, y, { align: "center" });

            doc.save(`Joining_Form_${data.get('Employee Name(AsperAadhar)') || 'Employee'}.pdf`);
        }
    </script>
</body>
</html>
